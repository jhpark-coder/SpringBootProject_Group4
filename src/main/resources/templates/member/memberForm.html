<!DOCTYPE html>
<html layout:decorate="~{fragment/layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<head>

    <link rel="stylesheet" th:href="@{/css/memberForm.css}">
</head>
<!-- ì‚¬ìš©ì CSS ì¶”ê°€ -->
<th:block layout:fragment="css">
    <style>
        .fieldError{
          color: #bd2130;
         }
         /* ğŸ‘‡ [ì¶”ê°€] disabledì²˜ëŸ¼ ë³´ì´ê²Œ í•  CSS í´ë˜ìŠ¤ */
        .readonly-as-disabled {
            background-color: #e9ecef; /* ë¶€íŠ¸ìŠ¤íŠ¸ë©ì˜ ê¸°ë³¸ disabled ë°°ê²½ìƒ‰ */
            opacity: 1; /* ê¸€ìê°€ ë„ˆë¬´ íë ¤ì§€ì§€ ì•Šê²Œ */
            cursor: not-allowed; /* ë§ˆìš°ìŠ¤ ì»¤ì„œë¥¼ 'ê¸ˆì§€' ëª¨ì–‘ìœ¼ë¡œ */
        }
    </style>
</th:block>
<!-- ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function(){
          var errorMessage = /*[[${errorMessage}]]*/ null;
          if(errorMessage != null){
            alert(errorMessage);
          }
           // ë…„ë„ ìƒì„± (1950ë…„ ~ í˜„ì¬ë…„ë„)
            var currentYear = new Date().getFullYear();
            for (var year = currentYear; year >= 1950; year--) {
                $("#birthYear").append('<option value="' + year + '">' + year + 'ë…„</option>');
            }
            
            // ì›” ìƒì„± (1~12ì›”)
            for (var month = 1; month <= 12; month++) {
                $("#birthMonth").append('<option value="' + month + '">' + month + 'ì›”</option>');
            }
            
            // ì¼ ìƒì„± (1~31ì¼)
            for (var day = 1; day <= 31; day++) {
                $("#birthDay").append('<option value="' + day + '">' + day + 'ì¼</option>');
            }

            // 3. ìµœì¢… íšŒì›ê°€ì… í•¨ìˆ˜ (formì˜ submit ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
            $("#registerForm").on("submit", function(e) {
                if (!isEmailVerified) {
                    e.preventDefault();
                    alert("ì´ë©”ì¼ ì¸ì¦ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.");
                    return;
                }

<!--                var formData = {-->
<!--                    name: $("#name").val(),-->
<!--                    email: $("#email").val(),-->
<!--                    password: $("#password").val(),-->
<!--                    passwordConfirm: $("#passwordConfirm").val(), // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ë“œ ì¶”ê°€-->
<!--                    gender: $("input[name='gender']:checked").val(), // ì„ íƒëœ ì„±ë³„ ê°’-->
<!--                    birthYear: $("select[name='birth-year']").val(), // ì„ íƒëœ ë…„ë„-->
<!--                    birthMonth: $("select[name='birth-month']").val(), // ì„ íƒëœ ì›”-->
<!--                    birthDay: $("select[name='birth-day']").val()-->
<!--                };-->

<!--                $.ajax({-->
<!--                    url: "/members/new",-->
<!--                    type: "POST",-->
<!--                    contentType: "application/json",-->
<!--                    data: JSON.stringify(formData),-->
<!--                    success: function(response) {-->
<!--                        alert(response);-->
<!--                        window.location.href = "/members/login";-->
<!--                    },-->
<!--                    error: function(xhr) {-->
<!--                        alert(xhr.responseText);-->
<!--                    }-->
<!--                });-->
            });
            // [í•µì‹¬] ì´ë©”ì¼ ì¸ì¦ ìƒíƒœë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
            var isEmailVerified = false;

            // CSRF í† í° ì„¤ì • (Spring Security ì‚¬ìš© ì‹œ)
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            // í† í°ì´ ì—†ìœ¼ë©´ ê²½ê³  ì¶œë ¥
            if (!token || !header) {
                console.error("CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                console.log("Available meta tags:", $("meta").map(function() { return $(this).attr('name'); }).get());
            }

            $(document).ajaxSend(function(e, xhr, options) {
                if (header && token) {
                    xhr.setRequestHeader(header, token);
                    console.log("CSRF í—¤ë” ì„¤ì •ë¨:", header, token);
                } else {
                    console.warn("CSRF í—¤ë” ì„¤ì • ì‹¤íŒ¨");
                }
            });

            // 1. ì¸ì¦ë©”ì¼ ë°œì†¡ í•¨ìˆ˜
              $("#sendAuthEmailBtn").on("click", function() {
                console.log("sendAuthEmail í•¨ìˆ˜ í˜¸ì¶œë¨");

                var email = $("#email").val();
                console.log("ì…ë ¥ëœ ì´ë©”ì¼:", email);

                if (!email) {
                    alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                console.log("AJAX ìš”ì²­ ì‹œì‘...");
                $.ajax({
                    url: "/members/email-auth",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ email: email }),
                    success: function(response) {
                        alert(response);
                        $("#verifyEmailBtn").prop("disabled", false);
                    },
                    error: function(xhr, status, error) {
                        alert("ì˜¤ë¥˜ ë°œìƒ: " + xhr.responseText);
                    }
                });
              });

            // 2. ì¸ì¦ì½”ë“œ í™•ì¸ í•¨ìˆ˜
            $("#verifyEmailBtn").on("click", function(){
                var email = $("#email").val();
                var authCode = $("#authCode").val();

                $.ajax({
                    url: "/members/email-verify",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ email: email, authCode: authCode }),
                    success: function(response) {
                        alert(response);
                        $("#emailVerifyMessage").text("ì¸ì¦ ì™„ë£Œ");
                        isEmailVerified = true;

                        $("#email").prop("readonly", true);
                        $("#email").addClass("readonly-as-disabled");

                        $("#sendAuthEmailBtn").prop("disabled", true);
                        $("#authCode").prop("disabled", true);
                        $("#verifyEmailBtn").prop("disabled", true);


                        checkFormValidity();
                    },
                    error: function(xhr) {
                        alert(xhr.responseText);
                        isEmailVerified = false;
                        checkFormValidity();
                    }
                });
            });



            // [í•µì‹¬] íšŒì›ê°€ì… ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ë¥¼ ì²´í¬í•˜ëŠ” í•¨ìˆ˜
            function checkFormValidity() {
                if (isEmailVerified) {
                    $("#submitBtn").prop("disabled", false);
                } else {
                    $("#submitBtn").prop("disabled", true);
                }
            }
        });
    </script>
</th:block>
<div layout:fragment="content">
    <div>

        <!-- í˜ì´ì§€ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ (íšŒìƒ‰ ë°°ê²½) -->
        <main class="signup-page-container">
            <!-- í°ìƒ‰ í¼ ì¹´ë“œ -->
            <div class="signup-form-wrapper">
                <h1 class="form-title">íšŒì›ê°€ì…</h1>

                <!--
                    ì´ë©”ì¼ê³¼ ì¸ì¦ ê´€ë ¨ í•„ë“œ.
                    form íƒœê·¸ ë°–ì— ìˆì§€ë§Œ, JavaScriptë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ êµ¬ì¡°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
                -->



                <!-- ì‹¤ì œ í¼ ì œì¶œ ì˜ì—­ -->
                <form action="/members/new" method="post" role="form" th:object="${memberFormDto}" id="registerForm">
                    <div class="form-group">
                        <label for="email">ì´ë©”ì¼ ì£¼ì†Œ(ë¡œê·¸ì¸ID)</label>
                        <div class="input-with-button">
                            <input type="email" id="email" class="email-check" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." th:field="*{email}">
                            <button type="button" id="sendAuthEmailBtn" class="btn btn-outline">ì¸ì¦ë©”ì¼ ë°œì†¡</button>
                        </div>
                        <p class="fieldError" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">Incorrect date</p>
                    </div>
                    <div class="form-group">
                        <label for="authCode">ì¸ì¦ì½”ë“œ</label>
                        <div class="input-with-button">
                            <input type="text" id="authCode" name="authCode" placeholder="ì¸ì¦ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <button type="button" id="verifyEmailBtn" class="btn btn-outline"  disabled>ì¸ì¦ í™•ì¸</button>
                        </div>
                        <span id="emailVerifyMessage" style="color:green;"></span>
                    </div>
                    <div class="form-group">
                        <label th:for="name">ë³„ëª…(í™œë™ëª…)</label>
                        <input type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." th:field="*{name}">
                        <p class="fieldError" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">Incorrect date</p>
                    </div>
                    <div class="form-group">
                        <label th:for="password">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" th:field="*{password}" autocomplete="new-password">
                        <p class="fieldError" th:if="${#fields.hasErrors('password')}" th:errors="*{password}">Incorrect date</p>
                    </div>

                    <!-- ===================================== -->
                    <!--            ğŸ‘‡ [ì¶”ê°€ëœ ë¶€ë¶„ ì‹œì‘] ğŸ‘‡         -->
                    <!-- ===================================== -->

                    <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
                    <div class="form-group">
                        <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œë²ˆ ì…ë ¥í•˜ì„¸ìš”">
                        <p class="fieldError" th:if="${#fields.hasErrors('passwordConfirm')}" th:errors="*{passwordConfirm}">Incorrect date</p>
                    </div>

                    <!-- ì„±ë³„ -->
                    <div class="form-group">
                        <label>ì„±ë³„</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="gender-male" name="gender" value="male" checked>
                                <label for="gender-male">ë‚¨ì„±</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="gender-female" name="gender" value="female">
                                <label for="gender-female">ì—¬ì„±</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="gender-other" name="gender" value="other">
                                <label for="gender-other">ê¸°íƒ€</label>
                            </div>
                            <p class="fieldError" th:if="${#fields.hasErrors('gender')}" th:errors="*{gender}">Incorrect date</p>
                        </div>
                    </div>

                    <!-- ìƒë…„ì›”ì¼ -->
                    <div class="form-group">
                        <label>ìƒë…„ì›”ì¼</label>
                        <div class="birthdate-group">
                            <select name="birthYear" aria-label="ì¶œìƒ ì—°ë„" id="birthYear">
                                <option>----ë…„</option>
                                <!-- JavaScriptë¡œ ë…„ë„ ì±„ìš°ê¸° -->
                            </select>
                            <p class="fieldError" th:if="${#fields.hasErrors('birthYear')}" th:errors="*{birthYear}">Incorrect date</p>
                            <select name="birthMonth" aria-label="ì¶œìƒ ì›”" id="birthMonth">
                                <option>--ì›”</option>
                                <!-- JavaScriptë¡œ ì›” ì±„ìš°ê¸° -->
                            </select>
                            <p class="fieldError" th:if="${#fields.hasErrors('birthMonth')}" th:errors="*{birthMonth}">Incorrect date</p>
                            <select name="birthDay" aria-label="ì¶œìƒ ì¼" id="birthDay">
                                <option>--ì¼</option>
                                <!-- JavaScriptë¡œ ì¼ ì±„ìš°ê¸° -->
                            </select>
                            <p class="fieldError" th:if="${#fields.hasErrors('birthDay')}" th:errors="*{birthDay}">Incorrect date</p>
                        </div>
                    </div>

                    <!-- ===================================== -->
                    <!--            ğŸ‘† [ì¶”ê°€ëœ ë¶€ë¶„ ë] ğŸ‘†           -->
                    <!-- ===================================== -->


                    <!-- type="submit"ì€ formì„ ì œì¶œí•˜ëŠ” ê¸°ë³¸ ë™ì‘ì„ í•©ë‹ˆë‹¤. -->
                    <button type="submit" class="btn btn-submit" id="submitBtn" disabled>ê°€ì…í•˜ê¸°</button>
                    <!-- CSRF í† í°ì€ form ë‚´ë¶€ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤. -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                </form>

            </div>
        </main>

    </div>
    </form>
</div>
</html>