<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/layout}">
<!-- jQuery -->
<head>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.8.js"></script>
</head>

<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/productdetall.css}">
    <style>
        .point-payment-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .point-payment-card {
            background: #fff;
            border: 1.5px solid #1ea7fd;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            padding: 32px 28px;
            margin-bottom: 24px;
        }

        .point-payment-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .point-payment-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #222;
            margin-bottom: 8px;
        }

        .point-payment-header p {
            font-size: 16px;
            color: #666;
            margin: 0;
        }

        .point-info-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .point-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .point-info-row:last-child {
            margin-bottom: 0;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
            font-weight: 700;
            font-size: 18px;
            color: #222;
        }

        .point-info-label {
            font-size: 16px;
            color: #666;
        }

        .point-info-value {
            font-size: 16px;
            color: #222;
            font-weight: 600;
        }

        .point-amount-section {
            margin-bottom: 32px;
        }

        .point-amount-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #222;
            margin-bottom: 16px;
        }

        .point-amount-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .point-amount-option {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .point-amount-option:hover {
            border-color: #1ea7fd;
            background: #f8f9fa;
        }

        .point-amount-option.selected {
            border-color: #1ea7fd;
            background: #e3f2fd;
        }

        .point-amount-value {
            font-size: 18px;
            font-weight: 700;
            color: #222;
            margin-bottom: 4px;
        }

        .point-amount-price {
            font-size: 14px;
            color: #666;
        }

        .point-amount-bonus {
            font-size: 12px;
            color: #1ea7fd;
            font-weight: 600;
            margin-top: 4px;
        }

        .custom-amount-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .custom-amount-input:focus {
            border-color: #1ea7fd;
        }

        .payment-method-section {
            margin-bottom: 32px;
        }

        .payment-method-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #222;
            margin-bottom: 16px;
        }

        .payment-method-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-method-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method-option:hover {
            border-color: #1ea7fd;
            background: #f8f9fa;
        }

        .payment-method-option.selected {
            border-color: #1ea7fd;
            background: #e3f2fd;
        }

        .payment-method-option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .payment-method-label {
            font-size: 16px;
            color: #222;
            font-weight: 500;
        }

        .payment-actions {
            display: flex;
            gap: 12px;
        }

        .payment-btn {
            flex: 1;
            padding: 16px 0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-btn.primary {
            background: #1ea7fd;
            color: #fff;
        }

        .payment-btn.primary:hover {
            background: #1976d2;
        }

        .payment-btn.secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }

        .payment-btn.secondary:hover {
            background: #e9ecef;
            color: #222;
        }

        .point-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .point-notice h4 {
            font-size: 14px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 8px;
        }

        .point-notice ul {
            margin: 0;
            padding-left: 20px;
        }

        .point-notice li {
            font-size: 13px;
            color: #856404;
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .point-amount-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .payment-actions {
                flex-direction: column;
            }
        }
    </style>
</th:block>

<div layout:fragment="content" class="point-payment-container">
    <div class="point-payment-card">
        <!-- í—¤ë” -->
        <div class="point-payment-header">
            <h1>í¬ì¸íŠ¸ ì¶©ì „</h1>
            <p>ì›í•˜ëŠ” ê¸ˆì•¡ì„ ì„ íƒí•˜ì—¬ í¬ì¸íŠ¸ë¥¼ ì¶©ì „í•˜ì„¸ìš”</p>
        </div>

        <!-- í¬ì¸íŠ¸ ì •ë³´ -->
        <div class="point-info-section">
            <div class="point-info-row">
                <span class="point-info-label">í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸</span>
                <span class="point-info-value" th:text="${#numbers.formatInteger(currentPoint ?: 0, 3, 'COMMA')} + 'P'">0P</span>
            </div>
            <div class="point-info-row">
                <span class="point-info-label">ì¶©ì „í•  í¬ì¸íŠ¸</span>
                <span class="point-info-value" id="selectedPointValue">0P</span>
            </div>
            <div class="point-info-row">
                <span class="point-info-label">ì¶©ì „ í›„ í¬ì¸íŠ¸</span>
                <span class="point-info-value" id="totalPointValue">0P</span>
            </div>
        </div>

        <!-- í¬ì¸íŠ¸ ì¶©ì „ ê¸ˆì•¡ ì„ íƒ -->
        <div class="point-amount-section">
            <h3>ì¶©ì „ ê¸ˆì•¡ ì„ íƒ</h3>
            <div class="point-amount-options">
                <div class="point-amount-option" data-point="100000" data-price="1">
                    <div class="point-amount-value">1,000P</div>
                    <div class="point-amount-price">1,000ì›</div>
                </div>
                <div class="point-amount-option" data-point="3000" data-price="3000">
                    <div class="point-amount-value">3,000P</div>
                    <div class="point-amount-price">3,000ì›</div>
                    <div class="point-amount-bonus">+100P ë³´ë„ˆìŠ¤</div>
                </div>
                <div class="point-amount-option" data-point="5000" data-price="5000">
                    <div class="point-amount-value">5,000P</div>
                    <div class="point-amount-price">5,000ì›</div>
                    <div class="point-amount-bonus">+200P ë³´ë„ˆìŠ¤</div>
                </div>
                <div class="point-amount-option" data-point="10000" data-price="10000">
                    <div class="point-amount-value">10,000P</div>
                    <div class="point-amount-price">10,000ì›</div>
                    <div class="point-amount-bonus">+500P ë³´ë„ˆìŠ¤</div>
                </div>
                <div class="point-amount-option" data-point="20000" data-price="20000">
                    <div class="point-amount-value">20,000P</div>
                    <div class="point-amount-price">20,000ì›</div>
                    <div class="point-amount-bonus">+1,200P ë³´ë„ˆìŠ¤</div>
                </div>
                <div class="point-amount-option" data-point="50000" data-price="50000">
                    <div class="point-amount-value">50,000P</div>
                    <div class="point-amount-price">50,000ì›</div>
                    <div class="point-amount-bonus">+3,500P ë³´ë„ˆìŠ¤</div>
                </div>
            </div>
            <input type="number" class="custom-amount-input" placeholder="ì§ì ‘ ì…ë ¥ (ìµœì†Œ 1,000P)" min="1000" step="1000">
        </div>

        <!-- ê²°ì œ ë°©ë²• ì„ íƒ -->
        <div class="payment-method-section">
            <h3>ê²°ì œ ë°©ë²• ì„ íƒ</h3>
            <div class="payment-method-options">
                <div class="payment-method-option">
                    <input type="radio" name="paymentMethod" value="card" id="card" checked>
                    <label for="card" class="payment-method-label">ì‹ ìš©ì¹´ë“œ</label>
                </div>
                <div class="payment-method-option">
                    <input type="radio" name="paymentMethod" value="bank" id="bank">
                    <label for="bank" class="payment-method-label">ê³„ì¢Œì´ì²´</label>
                </div>
                <div class="payment-method-option">
                    <input type="radio" name="paymentMethod" value="phone" id="phone">
                    <label for="phone" class="payment-method-label">íœ´ëŒ€í° ê²°ì œ</label>
                </div>
            </div>
        </div>

        <!-- í¬ì¸íŠ¸ ì´ìš© ì•ˆë‚´ -->
        <div class="point-notice">
            <h4>ğŸ“Œ í¬ì¸íŠ¸ ì´ìš© ì•ˆë‚´</h4>
            <ul>
                <li>í¬ì¸íŠ¸ëŠ” 1P = 1ì›ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤</li>
                <li>ì¶©ì „ëœ í¬ì¸íŠ¸ëŠ” í™˜ë¶ˆì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                <li>í¬ì¸íŠ¸ëŠ” ìƒí’ˆ êµ¬ë§¤ ì‹œì—ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                <li>ì •ê¸°êµ¬ë…ì€ í¬ì¸íŠ¸ë¡œ ê²°ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>
            </ul>
        </div>

        <!-- ê²°ì œ ë²„íŠ¼ -->
        <div class="payment-actions">
            <button class="payment-btn secondary" onclick="history.back()">ì·¨ì†Œ</button>
            <button class="payment-btn primary" onclick="requestPointPayment()">í¬ì¸íŠ¸ ì¶©ì „í•˜ê¸°</button>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        let selectedPoint = 0;
        let selectedPrice = 0;
        const currentPoint = parseInt('[[${currentPoint ?: 0}]]') || 0;

        // í¬ì¸íŠ¸ ê¸ˆì•¡ ì„ íƒ
        document.querySelectorAll('.point-amount-option').forEach(option => {
            option.addEventListener('click', function() {
                // ê¸°ì¡´ ì„ íƒ í•´ì œ
                document.querySelectorAll('.point-amount-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // í˜„ì¬ ì˜µì…˜ ì„ íƒ
                this.classList.add('selected');
                
                // ê°’ ì„¤ì •
                selectedPoint = parseInt(this.dataset.point);
                selectedPrice = parseInt(this.dataset.price);
                
                // ì»¤ìŠ¤í…€ ì…ë ¥ ì´ˆê¸°í™”
                document.querySelector('.custom-amount-input').value = '';
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                updatePointDisplay();
            });
        });

        // ì»¤ìŠ¤í…€ ê¸ˆì•¡ ì…ë ¥
        document.querySelector('.custom-amount-input').addEventListener('input', function() {
            const value = parseInt(this.value) || 0;
            if (value >= 1000) {
                selectedPoint = value;
                selectedPrice = value;
                
                // ê¸°ì¡´ ì„ íƒ í•´ì œ
                document.querySelectorAll('.point-amount-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                updatePointDisplay();
            }
        });

        // ê²°ì œ ë°©ë²• ì„ íƒ
        document.querySelectorAll('.payment-method-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-method-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                this.querySelector('input').checked = true;
            });
        });

        // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updatePointDisplay() {
            document.getElementById('selectedPointValue').textContent = selectedPoint.toLocaleString() + 'P';
            document.getElementById('totalPointValue').textContent = (currentPoint + selectedPoint).toLocaleString() + 'P';
        }

        // í¬ì¸íŠ¸ ê²°ì œ ìš”ì²­
        function requestPointPayment() {
            if (selectedPoint < 1000) {
                alert('ìµœì†Œ 1,000P ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (!confirm(`${selectedPoint.toLocaleString()}P ì¶©ì „ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê²°ì œ ê¸ˆì•¡: ${selectedPrice.toLocaleString()}ì›`)) {
                return;
            }

            // ì•„ì„í¬íŠ¸ ê²°ì œ ìš”ì²­
            IMP.init('imp20067661'); // ì‹¤ì œ ê°€ë§¹ì  ì½”ë“œë¡œ ë³€ê²½ í•„ìš”

            IMP.request_pay({
                pg: 'html5_inicis',
                pay_method: paymentMethod === 'card' ? 'card' : paymentMethod === 'bank' ? 'trans' : 'phone',
                merchant_uid: 'point_' + new Date().getTime(),
                name: 'í¬ì¸íŠ¸ ì¶©ì „',
                amount: selectedPrice,
                buyer_email: '[[${#authentication.name}]]',
                buyer_name: '[[${#authentication.principal.name}]]'
            }, function(rsp) {
                console.log('ì•„ì„í¬íŠ¸ ê²°ì œ ì‘ë‹µ:', rsp);
                if (rsp.success) {
                    console.log('ê²°ì œ ì„±ê³µ, í¬ì¸íŠ¸ ì¶©ì „ ìš”ì²­ ì‹œì‘');
                    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
                    const csrfMeta = document.querySelector('meta[name="_csrf"]');
                    const headerMeta = document.querySelector('meta[name="_csrf_header"]');
                    
                    let headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    // CSRF í† í°ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
                    if (csrfMeta && headerMeta) {
                        const token = csrfMeta.getAttribute('content');
                        const header = headerMeta.getAttribute('content');
                        headers[header] = token;
                    }
                    
                    // ê²°ì œ ì„±ê³µ ì‹œ ì„œë²„ì— í¬ì¸íŠ¸ ì¶©ì „ ìš”ì²­
                    fetch('/api/points/charge', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            amount: selectedPoint,
                            paymentAmount: selectedPrice,
                            impUid: rsp.imp_uid,
                            merchantUid: rsp.merchant_uid
                        })
                    })
                    .then(response => {
                        console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
                        if (data.success) {
                            // ì„±ê³µ ì‹œ ì„±ê³µ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì›ë˜ ìƒí’ˆ ID í¬í•¨)
                            const params = new URLSearchParams({
                                amount: selectedPoint,
                                paymentAmount: selectedPrice,
                                paymentMethod: paymentMethod === 'card' ? 'ì‹ ìš©ì¹´ë“œ' : paymentMethod === 'bank' ? 'ê³„ì¢Œì´ì²´' : 'íœ´ëŒ€í° ê²°ì œ',
                                merchantUid: rsp.merchant_uid,
                                impUid: rsp.imp_uid
                            });
                            
                            // URLì—ì„œ returnProductId íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
                            const urlParams = new URLSearchParams(window.location.search);
                            const returnProductId = urlParams.get('returnProductId');
                            if (returnProductId) {
                                params.append('returnProductId', returnProductId);
                            }
                            
                            window.location.href = '/api/points/charge/success?' + params.toString();
                        } else {
                            // ì‹¤íŒ¨ ì‹œ ì‹¤íŒ¨ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                            const params = new URLSearchParams({
                                errorMessage: data.message,
                                amount: selectedPoint,
                                paymentMethod: paymentMethod === 'card' ? 'ì‹ ìš©ì¹´ë“œ' : paymentMethod === 'bank' ? 'ê³„ì¢Œì´ì²´' : 'íœ´ëŒ€í° ê²°ì œ'
                            });
                            window.location.href = '/api/points/charge/fail?' + params.toString();
                        }
                    })
                    .catch(error => {
                        console.error('í¬ì¸íŠ¸ ì¶©ì „ ì˜¤ë¥˜:', error);
                        alert('í¬ì¸íŠ¸ ì¶©ì „ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
                } else {
                    // ê²°ì œ ì‹¤íŒ¨ ì‹œ ì‹¤íŒ¨ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    const params = new URLSearchParams({
                        errorMessage: rsp.error_msg,
                        errorCode: rsp.error_code || 'UNKNOWN',
                        amount: selectedPoint,
                        paymentMethod: paymentMethod === 'card' ? 'ì‹ ìš©ì¹´ë“œ' : paymentMethod === 'bank' ? 'ê³„ì¢Œì´ì²´' : 'íœ´ëŒ€í° ê²°ì œ'
                    });
                    window.location.href = '/api/points/charge/fail?' + params.toString();
                }
            });
        }

        // ì´ˆê¸° í¬ì¸íŠ¸ í‘œì‹œ
        updatePointDisplay();
    </script>
</th:block>

</html>