<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/layout}">
<!-- jQuery -->
<head>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.8.js"></script>
</head>

<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/productdetall.css}">
    <style>
        .point-payment-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .point-payment-card {
            background: #fff;
            border: 1.5px solid #1ea7fd;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            padding: 32px 28px;
            margin-bottom: 24px;
        }

        .point-payment-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .point-payment-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #222;
            margin-bottom: 8px;
        }

        .point-payment-header p {
            font-size: 16px;
            color: #666;
            margin: 0;
        }

        .point-info-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .point-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .point-info-row:last-child {
            margin-bottom: 0;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
            font-weight: 700;
            font-size: 18px;
            color: #222;
        }

        .point-info-label {
            font-size: 16px;
            color: #666;
        }

        .point-info-value {
            font-size: 16px;
            color: #222;
            font-weight: 600;
        }

        .point-amount-section {
            margin-bottom: 32px;
        }

        .point-amount-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #222;
            margin-bottom: 16px;
        }

        .point-amount-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .point-amount-option {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .point-amount-option:hover {
            border-color: #1ea7fd;
            background: #f8f9fa;
        }

        .point-amount-option.selected {
            border-color: #1ea7fd;
            background: #e3f2fd;
        }

        .point-amount-value {
            font-size: 18px;
            font-weight: 700;
            color: #222;
            margin-bottom: 4px;
        }

        .point-amount-price {
            font-size: 14px;
            color: #666;
        }

        .point-amount-bonus {
            font-size: 12px;
            color: #1ea7fd;
            font-weight: 600;
            margin-top: 4px;
        }

        .custom-amount-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .custom-amount-input:focus {
            border-color: #1ea7fd;
        }

        .payment-method-section {
            margin-bottom: 32px;
        }

        .payment-method-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #222;
            margin-bottom: 16px;
        }

        .payment-method-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-method-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method-option:hover {
            border-color: #1ea7fd;
            background: #f8f9fa;
        }

        .payment-method-option.selected {
            border-color: #1ea7fd;
            background: #e3f2fd;
        }

        .payment-method-option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .payment-method-label {
            font-size: 16px;
            color: #222;
            font-weight: 500;
        }

        .payment-actions {
            display: flex;
            gap: 12px;
        }

        .payment-btn {
            flex: 1;
            padding: 16px 0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-btn.primary {
            background: #1ea7fd;
            color: #fff;
        }

        .payment-btn.primary:hover {
            background: #1976d2;
        }

        .payment-btn.secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }

        .payment-btn.secondary:hover {
            background: #e9ecef;
            color: #222;
        }

        .point-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .point-notice h4 {
            font-size: 14px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 8px;
        }

        .point-notice ul {
            margin: 0;
            padding-left: 20px;
        }

        .point-notice li {
            font-size: 13px;
            color: #856404;
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .point-amount-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .payment-actions {
                flex-direction: column;
            }
        }
    </style>
</th:block>

<div layout:fragment="content" class="point-payment-container">
    <div class="point-payment-card">
        <!-- ν—¤λ” -->
        <div class="point-payment-header">
            <h1>ν¬μΈνΈ μ¶©μ „</h1>
            <p>μ›ν•λ” κΈμ•΅μ„ μ„ νƒν•μ—¬ ν¬μΈνΈλ¥Ό μ¶©μ „ν•μ„Έμ”</p>
        </div>

        <!-- ν¬μΈνΈ μ •λ³΄ -->
        <div class="point-info-section">
            <div class="point-info-row">
                <span class="point-info-label">ν„μ¬ λ³΄μ  ν¬μΈνΈ</span>
                <span class="point-info-value" th:text="${#numbers.formatInteger(currentPoint ?: 0, 3, 'COMMA')} + 'P'">0P</span>
            </div>
            <div class="point-info-row">
                <span class="point-info-label">μ¶©μ „ν•  ν¬μΈνΈ</span>
                <span class="point-info-value" id="selectedPointValue">0P</span>
            </div>
            <div class="point-info-row">
                <span class="point-info-label">μ¶©μ „ ν›„ ν¬μΈνΈ</span>
                <span class="point-info-value" id="totalPointValue">0P</span>
            </div>
        </div>

        <!-- ν¬μΈνΈ μ¶©μ „ κΈμ•΅ μ„ νƒ -->
        <div class="point-amount-section">
            <h3>μ¶©μ „ κΈμ•΅ μ„ νƒ</h3>
            <div class="point-amount-options">
                <div class="point-amount-option" data-point="10000000" data-price="1">
                    <div class="point-amount-value">1,000P</div>
                    <div class="point-amount-price">1,000μ›</div>
                </div>
                <div class="point-amount-option" data-point="3000" data-price="3000">
                    <div class="point-amount-value">3,000P</div>
                    <div class="point-amount-price">3,000μ›</div>
                    <div class="point-amount-bonus">+100P λ³΄λ„μ¤</div>
                </div>
                <div class="point-amount-option" data-point="5000" data-price="5000">
                    <div class="point-amount-value">5,000P</div>
                    <div class="point-amount-price">5,000μ›</div>
                    <div class="point-amount-bonus">+200P λ³΄λ„μ¤</div>
                </div>
                <div class="point-amount-option" data-point="10000" data-price="10000">
                    <div class="point-amount-value">10,000P</div>
                    <div class="point-amount-price">10,000μ›</div>
                    <div class="point-amount-bonus">+500P λ³΄λ„μ¤</div>
                </div>
                <div class="point-amount-option" data-point="20000" data-price="20000">
                    <div class="point-amount-value">20,000P</div>
                    <div class="point-amount-price">20,000μ›</div>
                    <div class="point-amount-bonus">+1,200P λ³΄λ„μ¤</div>
                </div>
                <div class="point-amount-option" data-point="50000" data-price="50000">
                    <div class="point-amount-value">50,000P</div>
                    <div class="point-amount-price">50,000μ›</div>
                    <div class="point-amount-bonus">+3,500P λ³΄λ„μ¤</div>
                </div>
            </div>
            <input type="number" class="custom-amount-input" placeholder="μ§μ ‘ μ…λ ¥ (μµμ† 1,000P)" min="1000" step="1000">
        </div>

        <!-- κ²°μ  λ°©λ²• μ„ νƒ -->
        <div class="payment-method-section">
            <h3>κ²°μ  λ°©λ²• μ„ νƒ</h3>
            <div class="payment-method-options">
                <div class="payment-method-option">
                    <input type="radio" name="paymentMethod" value="card" id="card" checked>
                    <label for="card" class="payment-method-label">μ‹ μ©μΉ΄λ“</label>
                </div>
                <div class="payment-method-option">
                    <input type="radio" name="paymentMethod" value="bank" id="bank">
                    <label for="bank" class="payment-method-label">κ³„μΆμ΄μ²΄</label>
                </div>
                <div class="payment-method-option">
                    <input type="radio" name="paymentMethod" value="phone" id="phone">
                    <label for="phone" class="payment-method-label">ν΄λ€ν° κ²°μ </label>
                </div>
            </div>
        </div>

        <!-- ν¬μΈνΈ μ΄μ© μ•λ‚΄ -->
        <div class="point-notice">
            <h4>π“ ν¬μΈνΈ μ΄μ© μ•λ‚΄</h4>
            <ul>
                <li>ν¬μΈνΈλ” 1P = 1μ›μΌλ΅ μ‚¬μ©λ©λ‹λ‹¤</li>
                <li>μ¶©μ „λ ν¬μΈνΈλ” ν™λ¶μ΄ λ¶κ°€λ¥ν•©λ‹λ‹¤</li>
                <li>ν¬μΈνΈλ” μƒν’ κµ¬λ§¤ μ‹μ—λ§ μ‚¬μ© κ°€λ¥ν•©λ‹λ‹¤</li>
                <li>μ •κΈ°κµ¬λ…μ€ ν¬μΈνΈλ΅ κ²°μ ν•  μ μ—†μµλ‹λ‹¤</li>
            </ul>
        </div>

        <!-- κ²°μ  λ²„νΌ -->
        <div class="payment-actions">
            <button class="payment-btn secondary" onclick="history.back()">μ·¨μ†</button>
            <button class="payment-btn primary" onclick="requestPointPayment()">ν¬μΈνΈ μ¶©μ „ν•κΈ°</button>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        let selectedPoint = 0;
        let selectedPrice = 0;
        const currentPoint = parseInt('[[${currentPoint ?: 0}]]') || 0;

        // ν¬μΈνΈ κΈμ•΅ μ„ νƒ
        document.querySelectorAll('.point-amount-option').forEach(option => {
            option.addEventListener('click', function() {
                // κΈ°μ΅΄ μ„ νƒ ν•΄μ 
                document.querySelectorAll('.point-amount-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // ν„μ¬ μµμ… μ„ νƒ
                this.classList.add('selected');
                
                // κ°’ μ„¤μ •
                selectedPoint = parseInt(this.dataset.point);
                selectedPrice = parseInt(this.dataset.price);
                
                // μ»¤μ¤ν…€ μ…λ ¥ μ΄κΈ°ν™”
                document.querySelector('.custom-amount-input').value = '';
                
                // ν™”λ©΄ μ—…λ°μ΄νΈ
                updatePointDisplay();
            });
        });

        // μ»¤μ¤ν…€ κΈμ•΅ μ…λ ¥
        document.querySelector('.custom-amount-input').addEventListener('input', function() {
            const value = parseInt(this.value) || 0;
            if (value >= 1000) {
                selectedPoint = value;
                selectedPrice = value;
                
                // κΈ°μ΅΄ μ„ νƒ ν•΄μ 
                document.querySelectorAll('.point-amount-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                updatePointDisplay();
            }
        });

        // κ²°μ  λ°©λ²• μ„ νƒ
        document.querySelectorAll('.payment-method-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-method-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                this.querySelector('input').checked = true;
            });
        });

        // ν¬μΈνΈ ν‘μ‹ μ—…λ°μ΄νΈ
        function updatePointDisplay() {
            document.getElementById('selectedPointValue').textContent = selectedPoint.toLocaleString() + 'P';
            document.getElementById('totalPointValue').textContent = (currentPoint + selectedPoint).toLocaleString() + 'P';
        }

        // ν¬μΈνΈ κ²°μ  μ”μ²­
        function requestPointPayment() {
            if (selectedPoint < 1000) {
                alert('μµμ† 1,000P μ΄μƒ μ„ νƒν•΄μ£Όμ„Έμ”.');
                return;
            }

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (!confirm(`${selectedPoint.toLocaleString()}P μ¶©μ „μ„ μ§„ν–‰ν•μ‹κ² μµλ‹κΉ?\nκ²°μ  κΈμ•΅: ${selectedPrice.toLocaleString()}μ›`)) {
                return;
            }

            // μ•„μ„ν¬νΈ κ²°μ  μ”μ²­
            IMP.init('imp20067661'); // μ‹¤μ  κ°€λ§Ήμ  μ½”λ“λ΅ λ³€κ²½ ν•„μ”

            IMP.request_pay({
                pg: 'html5_inicis',
                pay_method: paymentMethod === 'card' ? 'card' : paymentMethod === 'bank' ? 'trans' : 'phone',
                merchant_uid: 'point_' + new Date().getTime(),
                name: 'ν¬μΈνΈ μ¶©μ „',
                amount: selectedPrice,
                buyer_email: '[[${#authentication.name}]]',
                buyer_name: '[[${#authentication.principal.name}]]'
            }, function(rsp) {
                console.log('μ•„μ„ν¬νΈ κ²°μ  μ‘λ‹µ:', rsp);
                if (rsp.success) {
                    console.log('κ²°μ  μ„±κ³µ, ν¬μΈνΈ μ¶©μ „ μ”μ²­ μ‹μ‘');
                    
                    // CSRF ν† ν° κ°€μ Έμ¤κΈ°
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                    
                    // κ²°μ  μ„±κ³µ μ‹ μ„λ²„μ— ν¬μΈνΈ μ¶©μ „ μ”μ²­
                    fetch('/api/points/charge', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify({
                            amount: selectedPoint,
                            paymentAmount: selectedPrice,
                            impUid: rsp.imp_uid,
                            merchantUid: rsp.merchant_uid
                        })
                    })
                    .then(response => {
                        console.log('μ„λ²„ μ‘λ‹µ μƒνƒ:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('μ„λ²„ μ‘λ‹µ λ°μ΄ν„°:', data);
                        if (data.success) {
                            // μ„±κ³µ νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ (URL νλΌλ―Έν„°λ΅ μ •λ³΄ μ „λ‹¬)
                            const params = new URLSearchParams({
                                amount: selectedPoint,
                                paymentAmount: selectedPrice,
                                paymentMethod: paymentMethod,
                                merchantUid: rsp.merchant_uid,
                                impUid: rsp.imp_uid
                            });
                            window.location.href = `/api/points/charge/success?${params.toString()}`;
                        } else {
                            // μ‹¤ν¨ νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
                            const params = new URLSearchParams({
                                errorMessage: data.message,
                                amount: selectedPoint,
                                paymentMethod: paymentMethod
                            });
                            window.location.href = `/api/points/charge/fail?${params.toString()}`;
                        }
                    })
                    .catch(error => {
                        console.error('ν¬μΈνΈ μ¶©μ „ μ¤λ¥:', error);
                        alert('ν¬μΈνΈ μ¶©μ „ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
                    });
                } else {
                    alert('κ²°μ  μ‹¤ν¨: ' + rsp.error_msg);
                }
            });
        }

        // μ΄κΈ° ν¬μΈνΈ ν‘μ‹
        updatePointDisplay();
    </script>
</th:block>

</html>