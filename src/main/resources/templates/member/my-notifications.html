<!DOCTYPE html>
<html layout:decorate="~{fragment/layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/myPage.css}">
    </th:block>
    <title>알림 내역</title>
</head>

<body>
    <div layout:fragment="content" class="subpage-container">
        <!-- 왼쪽 사이드바 -->
        <div th:replace="~{fragment/myPage_sidebar}"></div>

        <!-- 오른쪽 메인 콘텐츠 -->
        <main class="subpage-content">
            <div class="page-header">
                <h1 class="page-title">알림 내역</h1>
                <p class="page-subtitle">받은 알림 내역을 확인할 수 있습니다.</p>
            </div>

            <!-- 알림 메시지 -->
            <div id="alertMessage" class="alert" style="display: none;"></div>

            <!-- 통계 정보 -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" th:text="${notifications == null ? 0 : notifications.size()}">0</div>
                    <div class="stat-label">전체 알림</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" th:text="${notifications == null ? 0 : notifications.?[!isRead].size()}">0
                    </div>
                    <div class="stat-label">읽지 않은 알림</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"
                        th:text="${notifications == null ? 0 : notifications.?[category?.name() == 'SYSTEM'].size()}">0
                    </div>
                    <div class="stat-label">시스템 알림</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"
                        th:text="${notifications == null ? 0 : notifications.?[category?.name() == 'ORDER'].size()}">0
                    </div>
                    <div class="stat-label">주문 알림</div>
                </div>
            </div>

            <!-- 알림 내역 테이블 -->
            <div class="content-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>카테고리</th>
                            <th>메시지</th>
                            <th>받은 시간</th>
                            <th>상태</th>
                            <th>이동</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="notification : ${notifications}" th:if="${!notifications.empty}"
                            th:classappend="${!notification.isRead} ? 'table-row unread' : 'table-row'">
                            <td>
                                <span
                                    th:class="${'category-badge category-' + #strings.toLowerCase(notification.category.name())}"
                                    th:text="${notification.category.toString().toLowerCase()}">시스템</span>
                            </td>
                            <td class="content-message" th:text="${notification.message}">알림 메시지</td>
                            <td class="content-time"
                                th:text="${#temporals.format(notification.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01
                                12:00
                            </td>
                            <td>
                                <span th:if="${notification.isRead}" class="status-read">✓ 읽음</span>
                                <span th:unless="${notification.isRead}" class="status-unread">● 안읽음</span>
                            </td>
                            <td>
                                <a th:if="${notification.link != null and notification.link != ''}"
                                   th:href="${notification.link}" 
                                   th:attr="data-notification-id=${notification.id}"
                                   class="btn btn-primary">관련 페이지로 이동</a>
                                <span th:unless="${notification.link != null and notification.link != ''}"
                                      class="text-muted">-</span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- 빈 상태 -->
                <div class="empty-state" th:if="${notifications.empty}">
                    <h3>알림이 없습니다</h3>
                    <p>아직 받은 알림이 없습니다.</p>
                    <a href="/" class="btn btn-primary">홈으로 돌아가기</a>
                </div>
            </div>

            <!-- 페이지네이션 (필요시 추가) -->
            <div class="pagination" th:if="${notifications.size() > 20}">
                <!-- 페이지네이션 로직 추가 예정 -->
            </div>
        </main>
    </div>

    <script th:inline="javascript">
        // 알림 관련 페이지로 이동 시 자동으로 읽음 처리
        document.addEventListener('DOMContentLoaded', function() {
            const notificationLinks = document.querySelectorAll('a[href]');
            notificationLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    // 알림 상태가 안읽음인 경우에만 읽음 처리
                    const row = this.closest('tr');
                    const statusCell = row.querySelector('.status-unread');
                    if (statusCell) {
                        // 알림 ID 추출 (테이블 행에서 알림 ID를 찾는 방법 필요)
                        const notificationId = this.getAttribute('data-notification-id');
                        if (notificationId) {
                            // 백엔드에 읽음 처리 요청
                            fetch(`/member/notifications/${notificationId}/mark-as-read`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            }).then(response => response.json())
                            .then(result => {
                                if (result.success) {
                                    // 클릭 시 즉시 읽음 상태로 변경 (시각적 피드백)
                                    statusCell.className = 'status-read';
                                    statusCell.textContent = '✓ 읽음';
                                }
                            }).catch(error => {
                                console.error('알림 읽음 처리 실패:', error);
                            });
                        }
                    }
                });
            });
        });
    </script>
</body>

</html>