<!DOCTYPE html>
<html layout:decorate="~{fragment/layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/myPage.css}">
    </th:block>
    <title>알림 내역</title>
</head>

<body>
    <div layout:fragment="content" class="subpage-container">
        <!-- 왼쪽 사이드바 -->
        <div th:replace="~{fragment/myPage_sidebar}"></div>

        <!-- 오른쪽 메인 콘텐츠 -->
        <main class="subpage-content">
            <div class="page-header">
                <h1 class="page-title">알림 내역</h1>
                <p class="page-subtitle">받은 알림 내역을 확인할 수 있습니다.</p>
            </div>

            <!-- 알림 메시지 -->
            <div id="alertMessage" class="alert" style="display: none;"></div>

            <!-- 통계 정보 -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" th:text="${notifications == null ? 0 : notifications.size()}">0</div>
                    <div class="stat-label">전체 알림</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" th:text="${notifications == null ? 0 : notifications.?[!isRead].size()}">0
                    </div>
                    <div class="stat-label">읽지 않은 알림</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"
                        th:text="${notifications == null ? 0 : notifications.?[category?.name() == 'SYSTEM'].size()}">0
                    </div>
                    <div class="stat-label">시스템 알림</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"
                        th:text="${notifications == null ? 0 : notifications.?[category?.name() == 'ORDER'].size()}">0
                    </div>
                    <div class="stat-label">주문 알림</div>
                </div>
            </div>

            <!-- 알림 내역 테이블 -->
            <div class="content-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>카테고리</th>
                            <th>메시지</th>
                            <th>받은 시간</th>
                            <th>상태</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="notification : ${notifications}" th:if="${!notifications.empty}"
                            th:classappend="${!notification.isRead} ? 'table-row unread' : 'table-row'">
                            <td>
                                <span
                                    th:class="${'category-badge category-' + #strings.toLowerCase(notification.category.name())}"
                                    th:text="${notification.category.toString().toLowerCase()}">시스템</span>
                            </td>
                            <td class="content-message" th:text="${notification.message}">알림 메시지</td>
                            <td class="content-time"
                                th:text="${#temporals.format(notification.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01
                                12:00
                            </td>
                            <td>
                                <span th:if="${notification.isRead}" class="status-read">✓ 읽음</span>
                                <span th:unless="${notification.isRead}" class="status-unread">● 안읽음</span>
                            </td>
                            <td>
                                <button th:if="${!notification.isRead}"
                                    th:onclick="'markAsRead(' + ${notification.id} + ')'" class="btn btn-primary">읽음
                                    표시</button>
                                <button th:onclick="'deleteNotification(' + ${notification.id} + ')'"
                                    class="btn btn-secondary action-btn">삭제</button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- 빈 상태 -->
                <div class="empty-state" th:if="${notifications.empty}">
                    <h3>알림이 없습니다</h3>
                    <p>아직 받은 알림이 없습니다.</p>
                    <a href="/" class="btn btn-primary">홈으로 돌아가기</a>
                </div>
            </div>

            <!-- 페이지네이션 (필요시 추가) -->
            <div class="pagination" th:if="${notifications.size() > 20}">
                <!-- 페이지네이션 로직 추가 예정 -->
            </div>
        </main>
    </div>

    <script th:inline="javascript">
        function markAsRead(notificationId) {
            fetch(`/notifications/${notificationId}/read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(result => {
                    const alertDiv = document.getElementById('alertMessage');
                    alertDiv.style.display = 'block';

                    if (result.success) {
                        alertDiv.className = 'alert alert-success';
                        alertDiv.textContent = '알림을 읽음으로 표시했습니다.';

                        // 페이지 새로고침
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        alertDiv.className = 'alert alert-danger';
                        alertDiv.textContent = result.message || '알림 상태 변경 중 오류가 발생했습니다.';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const alertDiv = document.getElementById('alertMessage');
                    alertDiv.style.display = 'block';
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = '알림 상태 변경 중 오류가 발생했습니다.';
                });
        }

        function deleteNotification(notificationId) {
            if (!confirm('이 알림을 삭제하시겠습니까?')) {
                return;
            }

            fetch(`/notifications/${notificationId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(result => {
                    const alertDiv = document.getElementById('alertMessage');
                    alertDiv.style.display = 'block';

                    if (result.success) {
                        alertDiv.className = 'alert alert-success';
                        alertDiv.textContent = '알림이 삭제되었습니다.';

                        // 페이지 새로고침
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        alertDiv.className = 'alert alert-danger';
                        alertDiv.textContent = result.message || '알림 삭제 중 오류가 발생했습니다.';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const alertDiv = document.getElementById('alertMessage');
                    alertDiv.style.display = 'block';
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = '알림 삭제 중 오류가 발생했습니다.';
                });
        }
    </script>
</body>

</html>