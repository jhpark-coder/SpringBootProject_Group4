<html layout:decorate="~{fragment/layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/myPage.css}">
        <link rel="stylesheet" th:href="@{/css/heartFollow.css}">
    </th:block>
</head>

<body>
    <div layout:fragment="content" class="page-container">
        <!-- 1. 왼쪽 고정 메뉴 (사이드바) -->
        <aside class="profile-sidebar">
            <div class="profile-pic"></div>
            <h2 class="profile-name" th:text="${Name} + ' 님'" sec:authentication="name">홍길동 님</h2>

            <div class="button-group">
                <a href="/members/liked-products" class="btn btn-outline">찜목록</a>
                <a href="/members/followings" class="btn btn-outline">팔로잉 목록</a>
            </div>

            <a th:href="@{/member/myPage/{id}/points(id=${#authentication.principal.id})}" class="btn btn-solid">포인트
                내역</a>
            <a th:href="@{/members/modify}" class="btn btn-solid">개인정보수정</a>
            <a th:href="@{/member/myPage/{id}/notifications(id=${#authentication.principal.id})}"
                class="btn btn-solid">알림내역</a>
            <a th:href="@{/api/orders/list}" class="btn btn-solid">구매내역</a>
            <a th:href="@{/refund/my-refunds}" class="btn btn-solid">환불 내역</a>
            <a th:href="@{/member/myBids}" class="btn btn-solid">참여중인 경매</a>
        </aside>

        <!-- 2. 오른쪽 메인 콘텐츠 -->
        <main class="main-content">
            <!-- 최근 구매/본 태그 차트 섹션 -->
            <section class="content-section chart-section">
                <div class="chart-item">
                    <div class="chart-placeholder">
                        <canvas id="monthlyPurchaseChart"></canvas>
                    </div>
                </div>
                <div class="chart-item">
                    <div class="chart-placeholder">
                        <canvas id="categoryPieChart"></canvas>
                        <button id="backToPrimaryBtn" class="btn btn-solid" hidden
                            style="margin-top: 10px;">돌아가기</button>
                    </div>
                </div>
            </section>

            <!-- 최근 구매한 작품 그리드 섹션 -->
            <section class="content-section">
                <header class="section-header">
                    <h2>최근 구매한 작품</h2>
                    <a href="#" class="see-more-link">더 보러가기 »</a>
                </header>

                <div class="product-grid" th:if="${recentProducts != null and !recentProducts.isEmpty()}">
                    <article th:each="product : ${recentProducts}" class="product-card">
                        <a th:href="@{/products/{id}(id=${product.id})}">
                            <div class="product-image-placeholder"
                                th:style="'background-image: url(\'' + ${product.imageUrl} + '\');'">
                            </div>
                        </a>
                        <div class="product-info">
                            <div class="seller-info">
                                <div class="seller-avatar"></div>
                                <span th:text="${product.seller.name}">판매자 이름</span>
                            </div>
                            <button class="follow-btn"
                                th:if="${product.seller != null and product.seller.email != #authentication.name}"
                                th:onclick="|toggleFollow(${product.seller.id})|"
                                sec:authorize="isAuthenticated()">Follow</button>
                            <button class="follow-btn" th:if="${product.seller != null}"
                                onclick="alert('로그인이 필요합니다.'); location.href='/members/login';"
                                sec:authorize="!isAuthenticated()">Follow</button>
                        </div>
                    </article>
                </div>
                <div th:if="${recentProducts == null or recentProducts.isEmpty()}">
                    <p>최근 구매한 작품이 없습니다.</p>
                </div>
            </section>

            <!-- 최근 열람한 작품 그리드 섹션 -->
            <section class="content-section">
                <header class="section-header">
                    <h2>최근 열람한 작품</h2>
                    <a href="#" class="see-more-link">더 보러가기 »</a>
                </header>
                <div class="product-grid" th:if="${recentViewedProducts != null and !recentViewedProducts.isEmpty()}">
                    <article th:each="product : ${recentViewedProducts}" class="product-card">
                        <a th:href="@{/products/{id}(id=${product.id})}">
                            <div class="product-image-placeholder"
                                th:style="'background-image: url(\'' + ${product.imageUrl} + '\');'">
                            </div>
                        </a>
                        <div class="product-info">
                            <div class="seller-info">
                                <div class="seller-avatar"></div>
                                <span th:text="${product.seller.name}">판매자 이름</span>
                            </div>
                            <button class="follow-btn"
                                th:if="${product.seller != null and product.seller.email != #authentication.name}"
                                th:onclick="|toggleFollow(${product.seller.id})|"
                                sec:authorize="isAuthenticated()">Follow</button>
                            <button class="follow-btn" th:if="${product.seller != null}"
                                onclick="alert('로그인이 필요합니다.'); location.href='/members/login';"
                                sec:authorize="!isAuthenticated()">Follow</button>
                        </div>
                    </article>
                </div>
                <div th:if="${recentViewedProducts == null or recentViewedProducts.isEmpty()}">
                    <p>최근 열람한 작품이 없습니다.</p>
                </div>
            </section>
        </main>
    </div>

    <th:block layout:fragment="script">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script th:src="@{/js/heartFollow.js}"></script>

        <script th:inline="javascript">
            /*<![CDATA[*/
            document.addEventListener("DOMContentLoaded", function () {
                // 월별 구매 차트
                const monthlyPurchaseCtx = document.getElementById('monthlyPurchaseChart');
                if (monthlyPurchaseCtx) {
                    const chartLabels = /*[[${chartLabels}]]*/[];
                    const chartDatasets = /*[[${chartDatasets}]]*/[];

                    new Chart(monthlyPurchaseCtx.getContext('2d'), {
                        type: 'bar',
                        data: { labels: chartLabels, datasets: chartDatasets },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: '최근 6개월간 카테고리별 구매량', font: { size: 18 } },
                                legend: { position: 'top' }
                            },
                            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                            animation: { duration: 1500, easing: 'easeInOutQuad' }
                        }
                    });
                }

                // 카테고리 파이 차트
                const primaryData = /*[[${primaryCategoryData}]]*/ {};
                const secondaryData = /*[[${secondaryCategoryData}]]*/ {};
                const pieChartCanvas = document.getElementById('categoryPieChart');
                const pieChartTitle = document.getElementById('pieChartTitle');
                const backButton = document.getElementById('backToPrimaryBtn');
                let pieChart;

                function createChartData(sourceData) {
                    const labels = Object.keys(sourceData);
                    const data = Object.values(sourceData);
                    const colors = labels.map(() => '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0'));
                    return {
                        labels: labels,
                        datasets: [{ data: data, backgroundColor: colors }]
                    };
                }

                function updateChart(chart, newData, newTitle) {
                    chart.data = createChartData(newData);
                    if (chart.options.plugins.title) chart.options.plugins.title.text = newTitle;
                    pieChartTitle.textContent = newTitle;
                    chart.update('active');
                }

                if (pieChartCanvas && primaryData && Object.keys(primaryData).length > 0) {
                    const initialChartData = createChartData(primaryData);

                    pieChart = new Chart(pieChartCanvas.getContext('2d'), {
                        type: 'pie',
                        data: initialChartData,
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: '최근 7일간 많이 본 카테고리', font: { size: 16 } },
                                legend: { position: 'bottom' },
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutQuad',
                                animateRotate: true,
                                animateScale: true
                            },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const clickedIndex = elements[0].index;
                                    const clickedLabel = pieChart.data.labels[clickedIndex];

                                    if (secondaryData[clickedLabel] && backButton.hidden) {
                                        updateChart(pieChart, secondaryData[clickedLabel], `'${clickedLabel}' 상세 카테고리`);
                                        backButton.hidden = false;
                                    }
                                }
                            }
                        }
                    });

                    backButton.addEventListener('click', () => {
                        updateChart(pieChart, primaryData, '최근 7일간 많이 본 카테고리');
                        backButton.hidden = true;
                    });
                }
            });
            /*]]>*/
        </script>
    </th:block>
</body>

</html>