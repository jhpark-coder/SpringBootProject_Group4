<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<!-- ë¬¸ì˜/ë‹µë³€ ì„¹ì…˜ Fragment -->
<div th:fragment="inquirySection(view)" class="inquiry-section-container">
    <h2 class="inquiry-title">ìƒí’ˆ ë¬¸ì˜</h2>

    <!-- ë¬¸ì˜ ëª©ë¡ -->
    <div class="inquiry-list">
        <!-- ìµœìƒìœ„ ë¬¸ì˜ë§Œ ë°˜ë³µ ì²˜ë¦¬. ë‹µë³€ì€ ê° ë¬¸ì˜ ì•„ë˜ì—ì„œ ì²˜ë¦¬. -->
        <div th:each="inquiry : ${view.inquiries.?[!isReply]}" th:classappend="${inquiry.isReply} ? 'reply' : ''"
            class="inquiry-item">

            <div class="inquiry-content">
                <span class="inquiry-author" th:text="${inquiry.writerName}">ì‘ì„±ì</span>

                <!-- 
                    ë¹„ë°€ê¸€ ê¶Œí•œ ì²´í¬ ë¡œì§ (ìµœì¢… ìˆ˜ì •)
                    - ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ ë¨¼ì € í™•ì¸ í›„, ì‚¬ìš©ì ì´ë¦„ì„ ë¹„êµí•˜ì—¬ SpelEvaluationException ë°©ì§€
                -->
                <th:block
                    th:with="isAllowed=${#authorization.expression('isAuthenticated()') and (#authentication.name == inquiry.writerEmail or #authentication.name == view.product.authorEmail)}">
                    <!-- ë¹„ë°€ê¸€ì¼ ê²½ìš° -->
                    <th:block th:if="${inquiry.isSecret}">
                        <span th:if="${!isAllowed}" class="secret-text">ğŸ”’ ë¹„ë°€ê¸€ì…ë‹ˆë‹¤.</span>
                        <p th:if="${isAllowed}" th:text="${inquiry.content}"></p>
                    </th:block>

                    <!-- ì¼ë°˜ê¸€ì¼ ê²½ìš° -->
                    <th:block th:unless="${inquiry.isSecret}">
                        <p th:text="${inquiry.content}">ë¬¸ì˜ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </th:block>
                </th:block>
            </div>

            <div class="inquiry-meta">
                <span th:text="${#temporals.format(inquiry.regTime, 'yyyy-MM-dd HH:mm')}">2024-01-01 12:00</span>
                <!-- 'ë‹µë³€í•˜ê¸°' ë²„íŠ¼: ìƒí’ˆ ì‘ì„±ìì´ê³ , ìµœìƒìœ„ ë¬¸ì˜ì¼ ê²½ìš°ì—ë§Œ í‘œì‹œ -->
                <button
                    th:if="${#authorization.expression('isAuthenticated()') and #authentication.name == view.product.authorEmail and !inquiry.isReply}"
                    th:attr="data-inquiry-id=${inquiry.id}"
                    onclick="toggleReplyForm(this.getAttribute('data-inquiry-id'))" class="reply-btn">
                    ë‹µë³€í•˜ê¸°
                </button>
            </div>

            <!-- ë‹µë³€ ì‘ì„± í¼ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
            <div th:if="${!inquiry.isReply}" th:id="|reply-form-${inquiry.id}|" class="reply-form"
                style="display:none;">
                <form
                    th:action="@{/products/{productId}/inquiries/{inquiryId}/replies(productId=${view.product.id}, inquiryId=${inquiry.id})}"
                    method="post">
                    <textarea name="content" rows="3" placeholder="ë‹µë³€ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
                    <div class="form-actions">
                        <label>
                            <input type="checkbox" name="isSecret" value="true"> ë¹„ë°€ê¸€
                        </label>
                        <button type="submit">ë‹µë³€ ë“±ë¡</button>
                    </div>
                </form>
            </div>

            <!-- ëŒ€ëŒ“ê¸€(ë‹µë³€) ëª©ë¡ -->
            <div th:each="reply : ${inquiry.children}" class="inquiry-item reply">
                <div class="inquiry-content">
                    <span class="inquiry-author" th:text="${reply.writerName}">ë‹µë³€ ì‘ì„±ì</span>
                    <th:block
                        th:with="isAllowed=${#authorization.expression('isAuthenticated()') and (#authentication.name == reply.writerEmail or #authentication.name == view.product.authorEmail)}">
                        <!-- ë¹„ë°€ê¸€ì¼ ê²½ìš° -->
                        <th:block th:if="${reply.isSecret}">
                            <span th:if="${!isAllowed}" class="secret-text">ğŸ”’ ë¹„ë°€ê¸€ì…ë‹ˆë‹¤.</span>
                            <p th:if="${isAllowed}" th:text="${reply.content}"></p>
                        </th:block>
                        <!-- ì¼ë°˜ê¸€ì¼ ê²½ìš° -->
                        <th:block th:unless="${reply.isSecret}">
                            <p th:text="${reply.content}">ë‹µë³€ ë‚´ìš©</p>
                        </th:block>
                    </th:block>
                </div>
                <div class="inquiry-meta">
                    <span th:text="${#temporals.format(reply.regTime, 'yyyy-MM-dd HH:mm')}">2024-01-01 12:00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¬¸ì˜ ì‘ì„± í¼ (ìµœìƒìœ„) -->
    <div class="inquiry-form">
        <h3>ë¬¸ì˜ ì‘ì„±</h3>
        <form th:action="@{/products/{id}/inquiries(id=${view.product.id})}" method="post">
            <textarea name="content" rows="4" placeholder="ìƒí’ˆì— ëŒ€í•œ ë¬¸ì˜ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
            <div class="form-actions">
                <label>
                    <input type="checkbox" name="isSecret" value="true"> ë¹„ë°€ê¸€
                </label>
                <button type="submit">ë“±ë¡</button>
            </div>
        </form>
    </div>

    <script>
        function toggleReplyForm(inquiryId) {
            const form = document.getElementById('reply-form-' + inquiryId);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        }
    </script>
    <style>
        .inquiry-section-container {
            margin-top: 40px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .inquiry-title {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .inquiry-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .inquiry-item {
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            padding: 15px;
        }

        .inquiry-item.reply {
            margin-left: 40px;
            border-color: #e0e0e0;
            background-color: #f9f9f9;
        }

        .inquiry-author {
            font-weight: bold;
            margin-right: 10px;
        }

        .secret-text {
            color: #888;
        }

        .inquiry-meta {
            font-size: 12px;
            color: #888;
            text-align: right;
            margin-top: 10px;
        }

        .reply-btn {
            background: none;
            border: 1px solid #007bff;
            color: #007bff;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .reply-form {
            margin-top: 15px;
            padding: 15px;
            border-top: 1px dashed #ddd;
        }

        .inquiry-form {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .inquiry-form textarea,
        .reply-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .inquiry-form .form-actions,
        .reply-form .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
    </style>
</div>

</html>