<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/layout}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/category_grid.css}">
    </th:block>
    <title>Nexus - 카테고리</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="category-grid-container">
            <div class="category-header">
                <h1 th:text="${primaryCategory}">아트웍</h1>
                <nav class="secondary-category-nav">
                    <ul>
                        <li>
                            <a th:href="@{/products/category/{name}(name=${primaryCategory}, page=1, secondary='all')}"
                                th:classappend="${secondaryCategory == 'all' ? 'active' : ''}">모두 보기</a>
                        </li>
                        <li th:each="category : ${secondaryCategories}">
                            <a th:href="@{/products/category/{name}(name=${primaryCategory}, page=1, secondary=${category})}"
                                th:text="${category}"
                                th:classappend="${secondaryCategory == category ? 'active' : ''}"></a>
                        </li>
                    </ul>
                </nav>
            </div>

            <div id="product-grid" class="row">
                <!-- 서버에서 렌더링한 초기 상품 목록 -->
                <div th:each="product : ${initialProductPage.products}" class="col-md-3">
                    <article class="grid-item">
                        <a th:href="@{/products/{id}(id=${product.id})}">
                            <div class="item-image-placeholder"
                                th:style="'background-image: url(\'' + ${product.imageUrl} + '\');'"></div>
                        </a>
                        <div class="item-info">
                            <div class="author-info">
                                <div class="author-avatar"></div>
                                <span class="author-name" th:text="${product.authorName}"></span>
                            </div>
                            <a href="#" class="btn subscribe-btn">Subscribe</a>
                        </div>
                    </article>
                </div>
                <!-- JS를 통해 동적으로 추가될 상품들 -->
            </div>

            <div id="loading-spinner" style="display: none; text-align: center; padding: 20px;">
                <p>로딩 중...</p>
            </div>

            <!-- 페이지네이션 컨트롤 -->
            <div id="pagination-controls" class="pagination-controls" th:if="${totalPages > 1}">
                <a th:if="${currentPage > 1}"
                    th:href="@{/products/category/{name}(name=${primaryCategory}, page=${currentPage - 1}, secondary=${secondaryCategory})}"
                    class="btn page-btn">
                    &lt; 이전 페이지
                </a>
                <span class="current-page-display" th:text="|${currentPage} / ${totalPages}|">1 / 50</span>
                <a th:if="${currentPage < totalPages}"
                    th:href="@{/products/category/{name}(name=${primaryCategory}, page=${currentPage + 1}, secondary=${secondaryCategory})}"
                    class="btn page-btn">
                    다음 페이지 &gt;
                </a>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function () {
                const primaryCategory = /*[[${primaryCategory}]]*/ 'artwork';
                const uiPage = /*[[${currentPage}]]*/ 1;
                const secondaryCategory = /*[[${secondaryCategory}]]*/ 'all';

                let jsFetchPage = 1; // JS는 항상 2번째 api 페이지부터 불러옴 (첫번째는 서버가 렌더링)
                const itemsPerFetch = 16;
                const maxJsFetches = 5; // JS는 최대 5번 더 불러옴 (16 * (1+5) = 96개)

                let isLoading = false;
                // 서버에서 전달된 첫 페이지가 마지막 페이지라면, 더이상 로드할 필요 없음
                let noMoreData = /*[[${initialProductPage.last}]]*/ false;

                function createProductCard(product) {
                    return `
                        <div class="col-md-3">
                            <article class="grid-item">
                                <a href="/products/${product.id}">
                                    <div class="item-image-placeholder" style="background-image: url('${product.imageUrl}');"></div>
                                </a>
                                <div class="item-info">
                                    <div class="author-info">
                                        <div class="author-avatar"></div>
                                        <span class="author-name">${product.authorName}</span>
                                    </div>
                                    <a href="#" class="btn subscribe-btn">Subscribe</a>
                                </div>
                            </article>
                        </div>
                    `;
                }

                function loadProducts() {
                    if (isLoading || noMoreData || jsFetchPage > maxJsFetches) {
                        return;
                    }
                    isLoading = true;
                    $('#loading-spinner').show();

                    const apiPagesPerUiPage = 6;
                    const apiPageOffset = (uiPage - 1) * apiPagesPerUiPage;
                    const apiPageToFetch = apiPageOffset + jsFetchPage;

                    const url = `/products/api/products/category?primary=${primaryCategory}&secondary=${secondaryCategory}&page=${apiPageToFetch}&size=${itemsPerFetch}&sort=regTime,desc`;

                    $.get(url, function (response) {
                        const products = response.products;
                        if (products.length > 0) {
                            products.forEach(product => {
                                $('#product-grid').append(createProductCard(product));
                            });
                            jsFetchPage++;
                        }

                        if (response.last || products.length < itemsPerFetch) {
                            noMoreData = true;
                        }

                        $('#loading-spinner').hide();
                        isLoading = false;
                    }).fail(function () {
                        console.error("Error loading products.");
                        $('#loading-spinner').hide();
                        isLoading = false;
                    });
                }

                $(window).scroll(function () {
                    if ($(window).scrollTop() + $(window).height() > $(document).height() - 300) {
                        loadProducts();
                    }
                });

                // 2차 카테고리 버튼들은 이제 실제 링크이므로, 별도의 JS 클릭 핸들러가 필요 없습니다.
            });
            /*]]>*/
        </script>
    </th:block>

</body>

</html>