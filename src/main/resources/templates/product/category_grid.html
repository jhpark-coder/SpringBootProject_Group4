<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/layout}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/category_grid.css}">
        <link rel="stylesheet" th:href="@{/css/heartFollow.css}">
    </th:block>
    <title>Nexus - 카테고리</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="category-grid-container">
            <div class="category-header">
                <h1 th:text="${primaryCategory}">아트워크</h1>
                <nav class="secondary-category-nav">
                    <ul>
                        <li>
                            <a th:href="@{/products/category/{name}(name=${primaryCategory}, page=1, secondary='all')}"
                                th:classappend="${secondaryCategory == 'all' ? 'active' : ''}">모두 보기</a>
                        </li>
                        <li th:each="category : ${secondaryCategories}">
                            <a th:href="@{/products/category/{name}(name=${primaryCategory}, page=1, secondary=${category})}"
                                th:text="${category}"
                                th:classappend="${secondaryCategory == category ? 'active' : ''}"></a>
                        </li>
                    </ul>
                </nav>
            </div>

            <div id="product-grid" class="row">
                <!-- 서버에서 렌더링한 초기 상품 목록 -->
                <div th:each="product : ${initialProductPage.products}" class="col-md-3">
                    <article class="grid-item">
                        <a th:href="@{/products/{id}(id=${product.id})}">
                            <div class="item-image-placeholder"
                                th:style="'background-image: url(\'' + ${product.imageUrl} + '\');'"></div>
                        </a>
                        <div class="item-info">
                            <div class="seller-info">
                                <div class="seller-avatar"></div>
                                <span class="seller-name" th:text="${product.sellerName}"></span>
                            </div>
                            <!-- 로그인한 사용자가 판매자 본인이 아닌 경우에만 팔로우 버튼 표시 -->
                            <button class="btn follow-btn"
                                    th:if="${product.sellerId != null}"
                                    th:data-member-id="${product.sellerId}"
                                    th:classappend="${product.isFollowing} ? ' following' : ''"
                                    th:onclick="|toggleFollow(${product.sellerId}, this)|"
                                    sec:authorize="isAuthenticated()"
                                    th:text="${product.isFollowing} ? 'Following' : 'Follow'">Follow</button>
                            <!-- 비로그인 사용자에게는 로그인 유도 -->
                            <button class="btn follow-btn"
                                    th:if="${product.sellerId != null}"
                                    onclick="alert('로그인이 필요합니다.'); location.href='/members/login';"
                                    sec:authorize="!isAuthenticated()">Follow</button>
                        </div>
                    </article>
                </div>
                <!-- JS를 통해 동적으로 추가될 상품들 -->
            </div>

            <div id="loading-spinner" style="display: none; text-align: center; padding: 20px;">
                <p>로딩 중...</p>
            </div>

            <!-- 페이지네이션 컨트롤 -->
            <div id="pagination-controls" class="pagination-controls" th:if="${totalPages > 1}">
                <a th:if="${currentPage > 1}"
                    th:href="@{/products/category/{name}(name=${primaryCategory}, page=${currentPage - 1}, secondary=${secondaryCategory})}"
                    class="btn page-btn">
                    &lt; 이전 페이지
                </a>
                <span class="current-page-display" th:text="|${currentPage} / ${totalPages}|">1 / 50</span>
                <a th:if="${currentPage < totalPages}"
                    th:href="@{/products/category/{name}(name=${primaryCategory}, page=${currentPage + 1}, secondary=${secondaryCategory})}"
                    class="btn page-btn">
                    다음 페이지 &gt;
                </a>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:src="@{/js/heartFollow.js}"></script>
        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function () {
                const primaryCategory = /*[[${primaryCategory}]]*/ 'artwork';
                const secondaryCategory = /*[[${secondaryCategory}]]*/ 'all';
                const totalPages = /*[[${totalPages}]]*/ 1;

                // 서버가 렌더링한 페이지는 0페이지(UI에서는 1페이지). JS는 1페이지부터 요청 시작.
                let currentPage = 1;
                let isLoading = false;
                // 서버에서 전달된 첫 페이지가 마지막 페이지라면, 더이상 로드할 필요 없음
                let noMoreData = /*[[${initialProductPage.last}]]*/ false;

                function createProductCard(product) {
                    // sellerId가 있는 경우에만 팔로우 버튼 생성
                    const followButton = product.sellerId ? 
                        `<button class="btn follow-btn" 
                                 data-member-id="${product.sellerId}"
                                 onclick="toggleFollow(${product.sellerId})">Follow</button>` : '';
                    
                    return `
                        <div class="col-md-3">
                            <article class="grid-item">
                                <a href="/products/${product.id}">
                                    <div class="item-image-placeholder" style="background-image: url('${product.imageUrl}');"></div>
                                </a>
                                <div class="item-info">
                                    <div class="seller-info">
                                        <div class="seller-avatar"></div>
                                        <span class="seller-name">${product.sellerName}</span>
                                    </div>
                                    ${followButton}
                                </div>
                            </article>
                        </div>
                    `;
                }

                function loadProducts() {
                    // 로딩 중이거나, 더 이상 데이터가 없거나, 총 페이지 수를 초과하면 중단
                    if (isLoading || noMoreData || currentPage >= totalPages) {
                        return;
                    }
                    isLoading = true;
                    $('#loading-spinner').show();

                    // API 엔드포인트 경로 수정 및 페이지 번호 직접 사용
                    const url = `/api/products/category?primary=${primaryCategory}&secondary=${secondaryCategory}&page=${currentPage}&size=16&sort=regTime,desc`;

                    $.get(url, function (response) {
                        const products = response.products;
                        if (products && products.length > 0) {
                            products.forEach(product => {
                                $('#product-grid').append(createProductCard(product));
                            });
                            currentPage++; // 다음 페이지를 불러오기 위해 페이지 번호 증가
                        }

                        // 응답의 last 플래그를 사용하여 더 이상 데이터가 없는지 확인
                        if (response.last) {
                            noMoreData = true;
                            $('#loading-spinner').hide(); // 더 이상 데이터가 없으면 로딩 스피너 숨김
                        }

                        isLoading = false;
                        // hide는 성공/실패 여부와 관계없이 항상 수행되도록 finally 블록처럼 처리
                    }).fail(function (xhr, status, error) {
                        console.error("상품 로딩 중 오류 발생:", status, error);
                        noMoreData = true; // 에러 발생 시 더 이상 시도하지 않음
                    }).always(function () {
                        $('#loading-spinner').hide();
                        isLoading = false;
                    });
                }

                $(window).scroll(function () {
                    // 스크롤이 하단에 가까워졌을 때 다음 페이지 로드
                    if ($(window).scrollTop() + $(window).height() > $(document).height() - 300) {
                        loadProducts();
                    }
                });

                // 강제 리플로우
                setTimeout(() => {
                    document.body.style.display = 'none';
                    void document.body.offsetHeight;
                    document.body.style.display = '';
                }, 0);
            });
            /*]]>*/
        </script>
    </th:block>

</body>

</html>