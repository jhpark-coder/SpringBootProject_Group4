<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragment/layout}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/category_grid.css}">
        <link rel="stylesheet" th:href="@{/css/heartFollow.css}">
    </th:block>
    <title>Nexus - 카테고리</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="category-grid-container">
            <div class="category-header">
                <h1 th:text="${primaryCategory}">아트워크</h1>
                <nav class="secondary-category-nav">
                    <ul>
                        <li>
                            <a th:href="@{/products/category/{name}(name=${primaryCategory}, page=1, secondary='all')}"
                                th:classappend="${secondaryCategory == 'all' ? 'active' : ''}">모두 보기</a>
                        </li>
                        <li th:each="category : ${secondaryCategories}">
                            <a th:href="@{/products/category/{name}(name=${primaryCategory}, page=1, secondary=${category})}"
                                th:text="${category}"
                                th:classappend="${secondaryCategory == category ? 'active' : ''}"></a>
                        </li>
                    </ul>
                </nav>
            </div>

            <div id="product-grid" class="row">
                <!-- 서버에서 렌더링한 초기 상품 목록 -->
                <div th:each="product : ${initialProductPage.products}" class="col-md-3">
                    <article class="grid-item">
                        <a th:href="@{/products/{id}(id=${product.id})}">
                            <div class="item-image-placeholder box"
                                th:attr="data-img-url=${product.imageUrl}"></div>
<!--                                th:style="'background-image: url(\'' + ${product.imageUrl} + '\');'"></div>-->
                        </a>
                        <div class="item-info">
                            <div class="seller-info">
                                <div class="seller-avatar"></div>
                                <span class="seller-name" th:text="${product.sellerName}"></span>
                            </div>
                            <!-- 로그인한 사용자가 판매자 본인이 아닌 경우에만 팔로우 버튼 표시 -->
                            <button class="btn follow-btn" 
                                    th:if="${product.sellerId != null}"
                                    th:data-member-id="${product.sellerId}"
                                    th:onclick="|toggleFollow(${product.sellerId})|"
                                    sec:authorize="isAuthenticated()">Follow</button>
                            <!-- 비로그인 사용자에게는 로그인 유도 -->
                            <button class="btn follow-btn"
                                    th:if="${product.sellerId != null}"
                                    onclick="alert('로그인이 필요합니다.'); location.href='/members/login';"
                                    sec:authorize="!isAuthenticated()">Follow</button>
                        </div>
                    </article>
                </div>
                <!-- JS를 통해 동적으로 추가될 상품들 -->
            </div>

            <div id="loading-spinner" style="display: none; text-align: center; padding: 20px;">
                <p>로딩 중...</p>
            </div>

            <!-- 페이지네이션 컨트롤 -->
            <div id="pagination-controls" class="pagination-controls" th:if="${totalPages > 1}">
                <a th:if="${currentPage > 1}"
                    th:href="@{/products/category/{name}(name=${primaryCategory}, page=${currentPage - 1}, secondary=${secondaryCategory})}"
                    class="btn page-btn">
                    &lt; 이전 페이지
                </a>
                <span class="current-page-display" th:text="|${currentPage} / ${totalPages}|">1 / 50</span>
                <a th:if="${currentPage < totalPages}"
                    th:href="@{/products/category/{name}(name=${primaryCategory}, page=${currentPage + 1}, secondary=${secondaryCategory})}"
                    class="btn page-btn">
                    다음 페이지 &gt;
                </a>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:src="@{/js/heartFollow.js}"></script>
        <script th:src="@{/js/grid-infinityLoad.js}"></script>
        <script th:src="@{/js/grid-animation.js}"></script>
    </th:block>

</body>

</html>