<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/layout}">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}" />
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}" />
    <title th:text="${product.name} + ' - Nexus'">Artwork Page</title>
    <link rel="stylesheet" th:href="@{/css/productResult.css}">
            gap: 8px;
        }

        .sidebar .tag-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 12px;
            color: #555;
        }

        .sidebar .description {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .sidebar .continue-btn {
            background: #ffc107;
            color: #333;
            width: 100%;
            padding: 12px 0;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        /* --- í‘¸í„° --- */
        .footer {
            background: #007bff;
            color: #fff;
            padding: 38px 0 24px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: auto;
        }

        .footer .footer-logo {
            width: 60px;
            height: 60px;
            background: #d9d9d9;
            border-radius: 8px;
        }

        .footer .sitename {
            font-size: 14px;
            margin-top: 5px;
        }

        .footer .copyright {
            font-size: 12px;
            color: #cce5ff;
            margin-top: 2px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="logo"></div>
        <nav>
            <ul>
                <li><a href="#">ê³ ê°ì„¼í„°</a></li>
                <li><a href="#">ì‘í’ˆê²½ë§¤</a></li>
                <li><a href="#">ë§ˆì´í˜ì´ì§€</a></li>
            </ul>
        </nav>
        <div class="user-info">
            <button class="points-btn">
                <span>ë³´ìœ í•œ í¬ì¸íŠ¸: 1000</span>
                <span style="font-size: 18px;">ğŸ””</span>
            </button>
        </div>
    </header>

    <!-- Category Bar -->
    <div class="category-bar">
        <button class="category-btn">ì•„íŠ¸ì›Œí¬</button>
        <button class="category-btn">ê·¸ë˜í”½ë””ìì¸</button>
        <button class="category-btn">ìºë¦­í„°</button>
        <button class="category-btn">Java</button>
        <button class="category-btn">í”„ë¡ íŠ¸ì—”ë“œ</button>
        <button class="category-btn">Python</button>
    </div>

    <!-- Main Content -->
    <main class="main-content" layout:fragment="content">
        <section class="artwork-section">
            <h1 th:text="${product.name}">ë‚˜ëŠ” ì´ ì‘í’ˆì˜ ì—„ì²­ë‚œ ì´ë¦„ì´ì‹œë‹¤.</h1>
            <img th:src="${product.imageUrl}" src="https://via.placeholder.com/800x600" alt="Artwork Image"
                class="artwork-image"
                onerror="this.src='https://via.placeholder.com/800x600/cccccc/666666?text=ì´ë¯¸ì§€ë¥¼+ë¶ˆëŸ¬ì˜¬+ìˆ˜+ì—†ìŠµë‹ˆë‹¤'">
            <div class="description-section" th:utext="${product.description}">
                <p>ì—¬ê¸°ì— TipTap ì—ë””í„°ë¡œ ì‘ì„±ëœ ìƒì„¸í•œ ìƒí’ˆ ì„¤ëª…ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
            </div>
        </section>

        <aside class="sidebar">
            <div class="seller-info">
                <div class="seller-profile">
                    <img src="https://via.placeholder.com/40" alt="íŒë§¤ì í”„ë¡œí•„" class="seller-pfp"
                                                            th:src="${product.seller?.profileImage ?: 'https://via.placeholder.com/40'}">
                    <span class="seller-name" th:text="${product.createdBy ?: 'ìµëª… íŒë§¤ì'}">íŒë§¤ìì´ë¦„ì´ ë“¤ì–´ê°€</span>
                </div>
                <button th:if="${#authentication.name != product.createdBy}" class="follow-btn">Follow</button>
            </div>
            <div class="tags">
                <button class="tag-btn"
                    th:text="${product.primaryCategory != null and product.primaryCategory != '' ? product.primaryCategory : 'ì•„íŠ¸ì›Œí¬'}">ì•„íŠ¸ì›Œí¬</button>
                <button class="tag-btn"
                    th:text="${product.secondaryCategory != null and product.secondaryCategory != '' ? product.secondaryCategory : 'í¬í† ê·¸ë˜í”¼'}">í¬í† ê·¸ë˜í”¼</button>
            </div>
            <p class="description">
                ë³´ì´ì‹œê² ì§€ë§Œ ì´ê³³ì€ ì„¤ëª…ì„ ë„£ëŠ” ê³³ ì…ë‹ˆë‹¤. ë‹¹ì—°í•˜ê²Œë„ ì„¤ëª…ë€ì…ë‹ˆë‹¤. ì°¸ìœ¼ë¡œ ë‹¤ì–‘í•œ ë°ì´í„°ë¥¼ ì ì„ ìˆ˜ ìˆëŠ” ì´ê³³ì€ ì„¤ëª…ë€ì…ë‹ˆë‹¤.
            </p>
            <div class="sidebar-actions">
                <button class="like-btn" th:data-product-id="${product.id}"
                    th:classappend="${#authentication.name != null and product.productHearts != null and product.productHearts.?[member.username == #authentication.name].size() > 0 ? 'liked' : ''}"
                    onclick="toggleLike(this)">
                    <span class="like-icon">ğŸ‘</span>
                    <span class="like-count" th:text="${heartCount ?: 0}">0</span>
                </button>
                <button class="continue-btn" onclick="alert('í¬ì¸íŠ¸ ê²°ì œ ê¸°ëŠ¥ ì¶”ê°€ ì˜ˆì •!')">
                    <span>30Pë¡œ ê³„ì†ë³´ê¸°</span>
                </button>
            </div>
        </aside>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-logo"></div>
        <p class="sitename">SiteName</p>
        <p class="copyright">2025 Copyright 4ì¡° í”„ë¡œì íŠ¸</p>
    </footer>

    <script>
        function toggleLike(button) {
            console.log('ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ë¨');

            const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

            // CSRF í† í°ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ í—¤ë”ì— ì¶”ê°€
            const headers = {
                'Content-Type': 'application/json'
            };

            if (csrfTokenMeta && csrfHeaderMeta && csrfTokenMeta.getAttribute('content') && csrfHeaderMeta.getAttribute('content')) {
                headers[csrfHeaderMeta.getAttribute('content')] = csrfTokenMeta.getAttribute('content');
                console.log('CSRF í† í° ì¶”ê°€ë¨:', csrfTokenMeta.getAttribute('content'));
            } else {
                console.log('CSRF í† í° ì—†ìŒ (ê°œë°œ í™˜ê²½)');
            }

            const productId = button.dataset.productId;
            const likeCountSpan = button.querySelector('.like-count');
            let currentCount = parseInt(likeCountSpan.textContent, 10);
            const isLiked = button.classList.contains('liked');

            // Optimistic UI: ë¨¼ì € UIë¥¼ ì¦‰ì‹œ ë³€ê²½
            if (isLiked) {
                likeCountSpan.textContent = Math.max(currentCount - 1, 0);
                button.classList.remove('liked');
            } else {
                likeCountSpan.textContent = currentCount + 1;
                button.classList.add('liked');
            }

            fetch(`/api/products/${productId}/heart`, {
                method: 'POST',
                headers: headers
            })
                .then(response => {
                    if (!response.ok) {
                        // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                        if (isLiked) {
                            likeCountSpan.textContent = currentCount;
                            button.classList.add('liked');
                        } else {
                            likeCountSpan.textContent = currentCount;
                            button.classList.remove('liked');
                        }
                        throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒíƒœ: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // ì„œë²„ ì‘ë‹µì— ë§ê²Œ ìµœì¢… ìƒíƒœ ë™ê¸°í™”
                    likeCountSpan.textContent = data.heartCount;
                    button.classList.toggle('liked', data.isLiked);
                    console.log('ì¢‹ì•„ìš” ìƒíƒœ ì—…ë°ì´íŠ¸ë¨ - ì¢‹ì•„ìš” ìˆ˜:', data.heartCount, 'ì¢‹ì•„ìš” ì—¬ë¶€:', data.isLiked);
                })
                .catch(error => {
                    console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
                    alert('ì˜¤ë¥˜: ' + error.message);
                });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ í™•ì¸
        document.addEventListener('DOMContentLoaded', function () {
            const likeBtn = document.querySelector('.like-btn');
            if (likeBtn) {
                const productId = likeBtn.dataset.productId;
                // ì¢‹ì•„ìš” ìƒíƒœ ë¹„ë™ê¸° ì¡°íšŒ
                fetch(`/api/products/${productId}/heart/status`)
                    .then(res => res.json())
                    .then(data => {
                        likeBtn.classList.toggle('liked', data.isLiked);
                        likeBtn.querySelector('.like-count').textContent = data.heartCount;
                    });
            }
        });
    </script>
</body>

</html>