<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/layout}">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}" />
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}" />
    <title th:text="${product.name} + ' - Nexus'">Artwork Page</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', Arial, sans-serif;
            background: #fff;
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        button {
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        /* --- í—¤ë” --- */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 60px;
            height: 80px;
            border-bottom: 1px solid #e0e0e0;
            background: #fff;
            position: relative;
        }

        .header .logo {
            width: 50px;
            height: 50px;
            background: #e0f2ff;
            border-radius: 8px;
            flex-shrink: 0;
            margin-left: 400px;
        }

        .header nav {
            position: absolute;
            left: 600px;
            right: 0;
            margin: auto;
            width: fit-content;
            top: 0;
            bottom: 0;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header nav ul {
            display: flex;
            gap: 48px;
            list-style: none;
            font-size: 17px;
            font-weight: bold;
        }

        .header .user-info {
            margin-left: auto;
        }

        .header .points-btn {
            background: #0071DE;
            color: #fff;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transition: opacity 0.2s;
        }

        .header .points-btn:hover {
            opacity: 0.9;
        }

        /* --- ì¹´í…Œê³ ë¦¬ ë°” --- */
        .category-bar {
            background: #007bff;
            padding: 14px 0;
            display: flex;
            justify-content: center;
            gap: 18px;
        }

        .category-bar .category-btn {
            background: #fff;
            color: #007bff;
            padding: 8px 32px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 500;
            border: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.07);
            transition: background 0.2s;
        }

        .category-bar .category-btn:hover {
            background: #e6f0ff;
        }

        /* --- ë©”ì¸ ì»¨í…ì¸  --- */
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 0 0 0;
        }

        .artwork-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .artwork-section h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 18px;
        }

        .artwork-image {
            width: 100%;
            max-width: 700px;
            aspect-ratio: 4/3;
            background: #d9d9d9;
            border-radius: 8px;
            object-fit: cover;
            display: block;
            margin-bottom: 0;
        }

        /* --- ì‚¬ì´ë“œë°” --- */
        .sidebar {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 22px 20px;
            height: fit-content;
            display: flex;
            flex-direction: column;
            gap: 18px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            min-width: 270px;
            max-width: 320px;
        }

        .sidebar .seller-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sidebar .seller-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar .seller-pfp {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .sidebar .seller-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .sidebar .subscribe-btn {
            background: #007bff;
            color: #fff;
            padding: 7px 16px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar .tags {
            display: flex;
            gap: 8px;
        }

        .sidebar .tag-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 12px;
            color: #555;
        }

        .sidebar .description {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .sidebar .continue-btn {
            background: #ffc107;
            color: #333;
            width: 100%;
            padding: 12px 0;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        /* --- í‘¸í„° --- */
        .footer {
            background: #007bff;
            color: #fff;
            padding: 38px 0 24px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: auto;
        }

        .footer .footer-logo {
            width: 60px;
            height: 60px;
            background: #d9d9d9;
            border-radius: 8px;
        }

        .footer .sitename {
            font-size: 14px;
            margin-top: 5px;
        }

        .footer .copyright {
            font-size: 12px;
            color: #cce5ff;
            margin-top: 2px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="logo"></div>
        <nav>
            <ul>
                <li><a href="#">ê³ ê°ì„¼í„°</a></li>
                <li><a href="#">ì‘í’ˆê²½ë§¤</a></li>
                <li><a href="#">ë§ˆì´í˜ì´ì§€</a></li>
            </ul>
        </nav>
        <div class="user-info">
            <a href="/members/point" class="points-btn">
                <span>ë³´ìœ í•œ í¬ì¸íŠ¸ : <span th:text="${#numbers.formatInteger(currentPoint ?: 0, 3, 'COMMA')}">0</span>P</span>
            </a>
        </div>
    </header>

    <!-- Category Bar -->
    <div class="category-bar">
        <button class="category-btn">ì•„íŠ¸ì›Œí¬</button>
        <button class="category-btn">ê·¸ë˜í”½ë””ìì¸</button>
        <button class="category-btn">ìºë¦­í„°</button>
        <button class="category-btn">Java</button>
        <button class="category-btn">í”„ë¡ íŠ¸ì—”ë“œ</button>
        <button class="category-btn">Python</button>
    </div>

    <!-- Main Content -->
    <main class="main-content" layout:fragment="content">
        <section class="artwork-section">
            <h1 th:text="${product.name}">ë‚˜ëŠ” ì´ ì‘í’ˆì˜ ì—„ì²­ë‚œ ì´ë¦„ì´ì‹œë‹¤.</h1>
            <img th:src="${product.imageUrl}" src="https://via.placeholder.com/800x600" alt="Artwork Image"
                class="artwork-image"
                onerror="this.src='https://via.placeholder.com/800x600/cccccc/666666?text=ì´ë¯¸ì§€ë¥¼+ë¶ˆëŸ¬ì˜¬+ìˆ˜+ì—†ìŠµë‹ˆë‹¤'">
            <div class="description-section" th:utext="${product.description}">
                <p>ì—¬ê¸°ì— TipTap ì—ë””í„°ë¡œ ì‘ì„±ëœ ìƒì„¸í•œ ìƒí’ˆ ì„¤ëª…ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
            </div>
        </section>

        <aside class="sidebar">
            <div class="seller-info">
                <div class="seller-profile">
                    <img src="https://via.placeholder.com/40" alt="íŒë§¤ì í”„ë¡œí•„" class="seller-pfp"
                                                            th:src="${product.seller?.profileImage ?: 'https://via.placeholder.com/40'}">
                    <span class="seller-name" th:text="${product.createdBy ?: 'ìµëª… íŒë§¤ì'}">íŒë§¤ìì´ë¦„ì´ ë“¤ì–´ê°€</span>
                </div>
                <button th:if="${#authentication.name != product.createdBy}" class="follow-btn">Follow</button>
            </div>
            <div class="tags">
                <button class="tag-btn"
                    th:text="${product.primaryCategory != null and product.primaryCategory != '' ? product.primaryCategory : 'ì•„íŠ¸ì›Œí¬'}">ì•„íŠ¸ì›Œí¬</button>
                <button class="tag-btn"
                    th:text="${product.secondaryCategory != null and product.secondaryCategory != '' ? product.secondaryCategory : 'í¬í† ê·¸ë˜í”¼'}">í¬í† ê·¸ë˜í”¼</button>
            </div>
            <p class="description">
                ë³´ì´ì‹œê² ì§€ë§Œ ì´ê³³ì€ ì„¤ëª…ì„ ë„£ëŠ” ê³³ ì…ë‹ˆë‹¤. ë‹¹ì—°í•˜ê²Œë„ ì„¤ëª…ë€ì…ë‹ˆë‹¤. ì°¸ìœ¼ë¡œ ë‹¤ì–‘í•œ ë°ì´í„°ë¥¼ ì ì„ ìˆ˜ ìˆëŠ” ì´ê³³ì€ ì„¤ëª…ë€ì…ë‹ˆë‹¤.
            </p>
            <div class="sidebar-actions">
                <button class="like-btn" th:data-product-id="${product.id}"
                    th:classappend="${#authentication.name != null and product.productHearts != null and product.productHearts.?[member.username == #authentication.name].size() > 0 ? 'liked' : ''}"
                    onclick="toggleLike(this)">
                    <span class="like-icon">ğŸ‘</span>
                    <span class="like-count" th:text="${heartCount ?: 0}">0</span>
                </button>
                <div class="purchase-buttons">
                    <button class="purchase-btn" onclick="requestPointPay()">
                        <span>30Pë¡œ êµ¬ë§¤í•˜ê¸°</span>
                    </button>
                    <button class="subscription-btn" onclick="requestSubscription()">
                        <span>ì •ê¸°êµ¬ë…ìœ¼ë¡œ ë³´ê¸°</span>
                    </button>
                </div>
            </div>
        </aside>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-logo"></div>
        <p class="sitename">SiteName</p>
        <p class="copyright">2025 Copyright 4ì¡° í”„ë¡œì íŠ¸</p>
    </footer>

    <script>
        function toggleLike(button) {
            console.log('ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ë¨');

            const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

            // CSRF í† í°ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ í—¤ë”ì— ì¶”ê°€
            const headers = {
                'Content-Type': 'application/json'
            };

            if (csrfTokenMeta && csrfHeaderMeta && csrfTokenMeta.getAttribute('content') && csrfHeaderMeta.getAttribute('content')) {
                headers[csrfHeaderMeta.getAttribute('content')] = csrfTokenMeta.getAttribute('content');
                console.log('CSRF í† í° ì¶”ê°€ë¨:', csrfTokenMeta.getAttribute('content'));
            } else {
                console.log('CSRF í† í° ì—†ìŒ (ê°œë°œ í™˜ê²½)');
            }

            const productId = button.dataset.productId;
            const likeCountSpan = button.querySelector('.like-count');
            let currentCount = parseInt(likeCountSpan.textContent, 10);
            const isLiked = button.classList.contains('liked');

            // Optimistic UI: ë¨¼ì € UIë¥¼ ì¦‰ì‹œ ë³€ê²½
            if (isLiked) {
                likeCountSpan.textContent = Math.max(currentCount - 1, 0);
                button.classList.remove('liked');
            } else {
                likeCountSpan.textContent = currentCount + 1;
                button.classList.add('liked');
            }

            fetch(`/api/products/${productId}/heart`, {
                method: 'POST',
                headers: headers
            })
                .then(response => {
                    if (!response.ok) {
                        // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                        if (isLiked) {
                            likeCountSpan.textContent = currentCount;
                            button.classList.add('liked');
                        } else {
                            likeCountSpan.textContent = currentCount;
                            button.classList.remove('liked');
                        }
                        throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒíƒœ: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // ì„œë²„ ì‘ë‹µì— ë§ê²Œ ìµœì¢… ìƒíƒœ ë™ê¸°í™”
                    likeCountSpan.textContent = data.heartCount;
                    button.classList.toggle('liked', data.isLiked);
                    console.log('ì¢‹ì•„ìš” ìƒíƒœ ì—…ë°ì´íŠ¸ë¨ - ì¢‹ì•„ìš” ìˆ˜:', data.heartCount, 'ì¢‹ì•„ìš” ì—¬ë¶€:', data.isLiked);
                })
                .catch(error => {
                    console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
                    alert('ì˜¤ë¥˜: ' + error.message);
                });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ í™•ì¸
        document.addEventListener('DOMContentLoaded', function () {
            const likeBtn = document.querySelector('.like-btn');
            if (likeBtn) {
                const productId = likeBtn.dataset.productId;
                // ì¢‹ì•„ìš” ìƒíƒœ ë¹„ë™ê¸° ì¡°íšŒ
                fetch(`/api/products/${productId}/heart/status`)
                    .then(res => res.json())
                    .then(data => {
                        likeBtn.classList.toggle('liked', data.isLiked);
                        likeBtn.querySelector('.like-count').textContent = data.heartCount;
                    });
            }
        });

        // í¬ì¸íŠ¸ ê²°ì œ í•¨ìˆ˜
        function requestPointPay() {
            const productId = window.location.pathname.split('/').pop();
            const price = 30; // ê³ ì • ê°€ê²©
            
            if (!confirm(`${price}Pë¡œ ì´ ìƒí’ˆì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            fetch(`/api/products/${productId}/purchase/point`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: productId,
                    price: price
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('í¬ì¸íŠ¸ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    window.location.reload();
                } else {
                    alert('í¬ì¸íŠ¸ ê²°ì œ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('í¬ì¸íŠ¸ ê²°ì œ ì˜¤ë¥˜:', error);
                alert('í¬ì¸íŠ¸ ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì •ê¸°êµ¬ë… í•¨ìˆ˜
        function requestSubscription() {
            const productId = window.location.pathname.split('/').pop();
            const authorName = document.querySelector('.seller-name').textContent;
            
            if (!confirm(`${authorName} ì‘ê°€ë‹˜ì˜ ì •ê¸°êµ¬ë…ì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì •ê¸°êµ¬ë… í˜œíƒ:\n- í•´ë‹¹ ì‘ê°€ì˜ ëª¨ë“  ì‘í’ˆì„ ë¬´ì œí•œìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n- ì›” 9,900ì› (ì²« ë‹¬ ë¬´ë£Œ)\n- ì–¸ì œë“ ì§€ í•´ì§€ ê°€ëŠ¥`)) {
                return;
            }
            
            // êµ¬ë… í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `/members/subscription?author=${encodeURIComponent(authorName)}&productId=${productId}`;
            
            fetch(`/api/products/${productId}/subscription`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: productId,
                    authorId: getAuthorIdFromPage()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ì •ê¸°êµ¬ë… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì²« ë‹¬ì€ ë¬´ë£Œë¡œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìœ¼ë©°, ë‹¤ìŒ ë‹¬ë¶€í„° ì›” 9,900ì›ì´ ìë™ìœ¼ë¡œ ê²°ì œë©ë‹ˆë‹¤.');
                    updateSubscriptionButton(true);
                } else {
                    alert('ì •ê¸°êµ¬ë… ì‹ ì²­ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ì •ê¸°êµ¬ë… ì˜¤ë¥˜:', error);
                alert('ì •ê¸°êµ¬ë… ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì‘ê°€ IDë¥¼ í˜ì´ì§€ì—ì„œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
        function getAuthorIdFromPage() {
            const authorElement = document.querySelector('.author-name');
            if (authorElement && authorElement.dataset.authorId) {
                return authorElement.dataset.authorId;
            }
            return null;
        }

        // êµ¬ë… ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateSubscriptionButton(isSubscribed) {
            const subscriptionBtn = document.querySelector('.subscription-btn');
            if (subscriptionBtn) {
                if (isSubscribed) {
                    subscriptionBtn.textContent = 'êµ¬ë… ì¤‘';
                    subscriptionBtn.style.background = '#28a745';
                    subscriptionBtn.onclick = function() {
                        alert('ì´ë¯¸ êµ¬ë… ì¤‘ì¸ ì‘ê°€ì…ë‹ˆë‹¤.');
                    };
                }
            }
        }
    </script>
</body>

</html>